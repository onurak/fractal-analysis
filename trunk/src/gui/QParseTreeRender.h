#ifndef QPARSETREERENDER_H
#define QPARSETREERENDER_H

#include <QGraphicsScene>
#include <QGraphicsView>
#include <QGraphicsItem>
#include <QGraphicsLineItem>
#include <QLinkedList>
#include <QGraphicsSceneMouseEvent>
#include "../fractallib/TimeSeries.h"
#include "../fractallib/parsers/SinglePass.h"
#include "Utils.h"
#include <cmath>

class QParseTreeScene: public QGraphicsScene
{
    Q_OBJECT
public:
    QParseTreeScene(): QGraphicsScene(0)
    {

    }

    ~QParseTreeScene()
    {

    }

protected:
    void mouseMoveEvent(QGraphicsSceneMouseEvent *event)
    {
        emit mouseMove(event);
        event->accept();
    }

signals:
    void mouseMove(QGraphicsSceneMouseEvent *event);
};

enum LayerDrawingOptions
{
    ldoNone             = 0x0,
    ldoDrawTimeSeries   = 0x1  //!< Draw time series generated by layer
};

class QParseTreeRender
{
public:


public:
    QParseTreeRender();
    virtual ~QParseTreeRender();

    void setTimeSeries(FL::TimeSeries *ts);
    void timeSeriesChanged();

    void setForest(FL::Trees::Forest *forest);
    void forestChanged();

    void setView(QGraphicsView *view);

    QParseTreeScene* scene() { return m_scene; }

    bool showRoots() const { return m_showRoots; }
    void setShowRoots(bool value) { m_showRoots = value; }

    int currentTree() const { return m_currentTree; }
    void setCurrentTree(int value) {
        m_currentTree = value;
        if (m_currentTree < 0)
            m_currentTree = 0;
        if (m_currentTree >= (int)m_forest->size())
            m_currentTree = m_forest->size() - 1;
        forestChanged();
    }

protected:
    void draw();
    void drawCoordinateSystem();
    void drawParseTree(FL::Trees::Tree *tree);
    void drawForest();
    void drawTimeSeries();
    void drawTreeLayer(const FL::Trees::Layer &layer,
                       QColor color,
                       LayerDrawingOptions options = ldoNone);
    void prepare();
private:
    int m_currentTree;
    bool m_showRoots;
private:
    QParseTreeScene *m_scene;
    QGraphicsView *m_view;
    FL::TimeSeries *m_ts;
    FL::Trees::Forest *m_forest;
    double m_tsYMin;
    double m_tsYMax;    
    //QLinkedList<QGraphicsItem*> m_tsItems;
    //QLinkedList<QGraphicsItem*> m_coordSystemItems;
};

#endif // QPARSETREERENDER_H
